# PredictDuel Solana Program Makefile
# Convenient commands for development and deployment

.PHONY: help install build test clean deploy-devnet deploy-mainnet verify lint format

help: ## Show this help message
	@echo "PredictDuel Solana Program"
	@echo ""
	@echo "Available commands:"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-20s\033[0m %s\n", $$1, $$2}'

install: ## Install dependencies
	@echo "ğŸ“¦ Installing dependencies..."
	npm install
	@echo "âœ… Dependencies installed"

build: ## Build the Solana program
	@echo "ğŸ—ï¸  Building program..."
	anchor build
	@echo "âœ… Build complete"

test: ## Run tests
	@echo "ğŸ§ª Running tests..."
	anchor test
	@echo "âœ… Tests complete"

test-skip-build: ## Run tests without building
	@echo "ğŸ§ª Running tests (skip build)..."
	anchor test --skip-build
	@echo "âœ… Tests complete"

clean: ## Clean build artifacts
	@echo "ğŸ§¹ Cleaning build artifacts..."
	rm -rf target/
	rm -rf .anchor/
	rm -rf node_modules/
	@echo "âœ… Clean complete"

deploy-localnet: build ## Deploy to localnet
	@echo "ğŸš€ Deploying to localnet..."
	./scripts/deploy.sh localnet

deploy-devnet: build ## Deploy to devnet
	@echo "ğŸš€ Deploying to devnet..."
	./scripts/deploy.sh devnet

deploy-mainnet: build ## Deploy to mainnet (use with caution!)
	@echo "âš ï¸  Deploying to MAINNET..."
	./scripts/deploy.sh mainnet

verify: ## Verify program deployment
	@echo "ğŸ” Verifying program..."
	solana program show $$(solana address -k target/deploy/predict_duel-keypair.json)

program-id: ## Display program ID
	@solana address -k target/deploy/predict_duel-keypair.json

balance: ## Check wallet balance
	@solana balance

airdrop: ## Request airdrop (devnet only)
	@echo "ğŸ’° Requesting airdrop..."
	solana airdrop 2
	@solana balance

lint: ## Run linter
	@echo "ğŸ” Running linter..."
	cargo clippy -- -D warnings

format: ## Format code
	@echo "âœ¨ Formatting code..."
	cargo fmt

watch: ## Watch for changes and rebuild
	@echo "ğŸ‘€ Watching for changes..."
	cargo watch -x build

logs: ## Stream program logs
	@echo "ğŸ“œ Streaming logs for program..."
	solana logs $$(solana address -k target/deploy/predict_duel-keypair.json)

cluster-info: ## Show current cluster configuration
	@echo "ğŸŒ Cluster Configuration:"
	@solana config get

set-devnet: ## Set cluster to devnet
	@solana config set --url devnet
	@echo "âœ… Switched to devnet"

set-mainnet: ## Set cluster to mainnet
	@solana config set --url mainnet-beta
	@echo "âœ… Switched to mainnet"

set-localnet: ## Set cluster to localnet
	@solana config set --url localhost
	@echo "âœ… Switched to localnet"

start-validator: ## Start local validator
	@echo "ğŸƒ Starting local validator..."
	solana-test-validator

idl: ## Generate and copy IDL
	@echo "ğŸ“„ Generating IDL..."
	anchor build
	@cp target/idl/predict_duel.json public/idl/
	@echo "âœ… IDL copied to public/idl/"

sdk: ## Build TypeScript SDK
	@echo "ğŸ“¦ Building TypeScript SDK..."
	cd client && npm run build
	@echo "âœ… SDK built"

docs: ## Generate documentation
	@echo "ğŸ“š Generating documentation..."
	cargo doc --no-deps --open

upgrade: ## Upgrade deployed program
	@echo "â¬†ï¸  Upgrading program..."
	anchor upgrade target/deploy/predict_duel.so --program-id $$(solana address -k target/deploy/predict_duel-keypair.json)

size: ## Show program size
	@echo "ğŸ“Š Program size:"
	@du -h target/deploy/predict_duel.so

all: clean install build test ## Clean, install, build, and test
	@echo "âœ… All tasks complete!"

